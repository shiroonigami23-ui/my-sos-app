<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOS Mesh Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1f2937">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .alert-card { transition: all 0.3s ease; }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto p-6 bg-gray-800 rounded-2xl shadow-2xl border border-gray-700">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-red-400">SOS Mesh Control Panel</h1>
            <p class="text-gray-400 mt-2">Connect to your ESP32 device to send and monitor mesh alerts.</p>
        </div>

        <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-6">
            <button id="connectButton" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-500">
                Connect to Device
            </button>
            <div id="status" class="mt-2 sm:mt-0 text-center sm:text-left text-sm font-medium py-2 px-4 rounded-md bg-gray-700 text-gray-300">
                Status: Disconnected
            </div>
        </div>

        <div class="mb-6">
            <button id="sosButton" disabled class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-6 rounded-lg text-xl transition-all duration-300 disabled:bg-gray-600 disabled:cursor-not-allowed disabled:opacity-50 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-red-500">
                TRIGGER SOS SIGNAL
            </button>
        </div>

        <div>
            <div class="flex justify-between items-center mb-2">
                 <h2 class="text-xl font-semibold text-gray-300">Incoming Alerts</h2>
                 <button id="clearButton" class="text-sm text-blue-400 hover:underline">Clear</button>
            </div>
            <div id="log" class="h-80 bg-black bg-opacity-50 rounded-lg p-2 space-y-2 overflow-y-auto border border-gray-700">
                <p id="placeholder" class="text-gray-500 p-4 text-center">Waiting for alerts...</p>
            </div>
        </div>
    </div>

    <script>
        const connectButton = document.getElementById('connectButton');
        const sosButton = document.getElementById('sosButton');
        const statusDiv = document.getElementById('status');
        const logDiv = document.getElementById('log');
        const clearButton = document.getElementById('clearButton');
        const placeholder = document.getElementById('placeholder');

        let port;
        let reader;
        let writer;
        let lineBuffer = '';
        const encoder = new TextEncoder();
        const decoder = new TextDecoder();

        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('Service Worker registered successfully'))
                .catch(err => console.error('Service Worker registration failed:', err));
        }

        connectButton.addEventListener('click', async () => port ? disconnect() : connect());

        sosButton.addEventListener('click', async () => {
            if (!writer) return;
            await writer.write(encoder.encode("SOS\n"));
            console.log("Sent SOS command.");
        });

        clearButton.addEventListener('click', () => {
            logDiv.innerHTML = '';
            logDiv.appendChild(placeholder);
        });

        async function connect() {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });

                writer = port.writable.getWriter();
                
                statusDiv.textContent = 'Status: Connected';
                statusDiv.classList.replace('bg-gray-700', 'bg-green-700');
                connectButton.textContent = 'Disconnect';
                sosButton.disabled = false;
                
                // Start reading from the port
                readLoop();
            } catch (error) {
                console.error('Connection failed:', error);
                statusDiv.textContent = 'Status: Connection Failed';
            }
        }

        async function disconnect() {
            if (reader) {
                await reader.cancel();
                reader = null;
            }
            if (writer) {
                await writer.close();
                writer = null;
            }
            if (port) {
                await port.close();
                port = null;
            }
            statusDiv.textContent = 'Status: Disconnected';
            statusDiv.classList.replace('bg-green-700', 'bg-gray-700');
            connectButton.textContent = 'Connect to Device';
            sosButton.disabled = true;
        }

        async function readLoop() {
            if (!port?.readable) return;
            reader = port.readable.getReader();
            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    lineBuffer += decoder.decode(value, { stream: true });
                    const lines = lineBuffer.split('\n');
                    lineBuffer = lines.pop(); // Keep the last, possibly incomplete, line

                    lines.forEach(line => {
                        if (line.trim().startsWith('{')) {
                            try {
                                const data = JSON.parse(line.trim());
                                addAlertToLog(data);
                            } catch (e) {
                                console.warn("Received non-JSON line:", line);
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Read loop error:', error);
            } finally {
                reader.releaseLock();
            }
        }

        function addAlertToLog(data) {
            placeholder.style.display = 'none';

            const card = document.createElement('div');
            card.className = 'alert-card bg-gray-700 p-3 rounded-lg border-l-4 border-red-500';
            
            const hasLocation = data.lat !== 0.0 && data.lon !== 0.0;
            const locationString = hasLocation ? `${data.lat.toFixed(5)}, ${data.lon.toFixed(5)}` : 'No GPS Lock';
            const mapLink = hasLocation ? `https://www.google.com/maps?q=${data.lat},${data.lon}` : '#';

            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-bold text-white">${data.message}</p>
                        <p class="text-xs text-gray-400 font-mono">From: ${data.sender}</p>
                        <p class="text-xs text-gray-400 font-mono">GPS: ${locationString}</p>
                    </div>
                    ${hasLocation ? `<a href="${mapLink}" target="_blank" class="ml-2 flex-shrink-0 bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-1 px-2 rounded">Map</a>` : ''}
                </div>
            `;
            logDiv.prepend(card); // Add new alerts to the top
        }

    </script>
</body>
</html>

